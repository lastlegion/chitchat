<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ChitChat simulator</title>
    <style type="text/css">
        table{
           // border: 1px solid #333;
           float: left;
           margin-left: 25px;
        }
        td{
            padding: 7px;
            border: 1px solid #333;
        }
        .safe{
            background: green;
        }
        .danger{
            background: red;
        }
        #messages{
            font-family: courier, arial;
        }
        #plot{
            clear: both;
        }
        body{
            font-family: Tahoma, Verdana;
        }
        #buttons{
            margin: 20px 80px;
        }
        #buttons div{
            display: inline;
        }
        h1{
            text-align: center;
        }
        body{
            text-align: center;
        }
        #main{
            margin: 0 auto;
            width: 900px;
        }
        .button{
            padding: 8px 12px;
         //   background: #ccc;
            width: 120px;
            margin: 12px;
        }
    </style>

</head>
<body>
    <h1>ChitChat simulator</h1>   
    <div id="buttons">
                <button class="button" id="run">Run </button>
    </div>
   <div id="main"></div> 
   <div id="messages"></div>
   <div id="plot" height="450px" width="850px"></div>
</body>
    <script type="text/javascript" src="Chart.js/Chart.js"></script>
    <script type="text/javascript" src="jsapi.js"></script>
    <script type="text/javascript">

    var size;
    var TURNS = 1020;


    var plotGraph = function(raw_data){
      google.load("visualization", "1", {packages:["corechart"]});
      google.setOnLoadCallback(drawChart);
      
      var proc_data = [];
      for(var i=0; i<TURNS; i++){
        proc_data[i] = [];
        proc_data[i][0] = (i);
        proc_data[i][1] = (raw_data[i]);
      }
      
      
    
      function drawChart() {
        var data = google.visualization.arrayToDataTable(proc_data);

        var options = {
          title: 'Performance'
        };

        var chart = new google.visualization.LineChart(document.getElementById('plot'));
        chart.draw(data, options);
    }

    console.log("here");
    }

      
    var plotGrapht = function(raw_data) {
        var labels = [];
        for(var i=0; i<= TURNS/10; i++ ){
            labels[i] = i*10;
        }
        
        console.log(raw_data);
        var data = { 
            labels: labels,
            datasets:[
                {
                    fillColor : "rgba(220,220,220,0.5)",
                    strokeColor : "rgba(220,220,220,1)",
                    pointColor : "rgba(220,220,220,1)",
                    pointStrokeColor : "#fff",
                    data: raw_data
                }
            ] 
        }
        var options = {
            //scaleOverride : true,
            //scaleStepWidth: 400 
            //scaleLabel: ""
            //scaleShowLabels: false
        }
        //Plotting graph
        var ctx = document.getElementById("plot").getContext("2d");
        var myPlot = new Chart(ctx).Line(data, options);
    };


    var shuffle = function(o) {
        for(var j,x,i = o.length; i; j = parseInt(Math.random() * i), x= o[--i],o[i] = o[j], o[j] = x);
        return o;
    };
    var randomn = function(n){
        var move = Math.floor((Math.random()*n) + 1);
        return move;
    }
    var make_move = function(tokens, i, j, x ){
        var move = Math.floor((Math.random()*4) + 1);
        //check if valid

        var top_move = function(){
            tokens[i-1][j].push(tokens[i][j].splice(x,1)*1)
        };
        var right_move = function(){
             tokens[i][j+1].push(tokens[i][j].splice(x,1)*1);
        };
        var left_move = function(){
             tokens[i][j-1].push(tokens[i][j].splice(x,1)*1);
        };
        var bottom_move = function(){
            tokens[i+1][j].push(tokens[i][j].splice(x,1)*1);
        };
        
        if(move == 1){  //top
            //bounds check
            if(i == 0){     //topmost row
                move = randomn(3);
                console.log(move);
                if(j==0){ //topleft corner
                    move = Math.floor((Math.random()*2)+1);
                    if(move == 1)
                        right_move();
                    else
                        bottom_move();
                } else if(j==size-1){   //topright corner
                    move = Math.floor((Math.random()*2)+1);
                    if(move == 1)
                        left_move();
                    else
                        bottom_move();
                } else {
                    if(move == 1)
                        bottom_move();
                    else if (move == 2)
                        left_move();
                    else if (move == 3)
                        right_move();
                }
            } else 
                top_move();

        } else if(move == 2){   //right
            //bounds check

            if(j==size-1){  
                move = randomn(3);
                if(i==0){   //topright corner
                    move = randomn(2);
                    if(move == 1)
                        left_move();
                    else
                        bottom_move();
                } else if(i==size-1){   //bottomright
                    move = randomn(2);
                    if(move == 1)
                        left_move();
                    else
                        top_move();
                } else{     //rightmost
                    if(move == 1)
                        top_move();  
                    else if (move == 2)
                        left_move();
                    else if (move == 3)
                        bottom_move();           
                }
            } else 
                right_move();
        } else if(move == 3){   //bottom
            //bounds check
            if(i == size-1){
                move = randomn(3);
                if(j == 0){ //bottom left
                    move = randomn(2);
                    if(move == 1)
                        right_move();
                    else 
                        top_move();
                } else if(j == size -1){    //bottom right
                    move = randomn(2);
                    if(move == 1)
                        left_move();
                    else
                        top_move();
                } else {          
                    if(move == 1){
                        top_move();
                    } else if (move == 2){
                        left_move();
                    } else if (move == 3){
                        right_move();
                    }
                }   
            } else {
                bottom_move();
            }
        } else if(move == 4){   //left
            //bounds check
            if(j == 0){
                move = randomn(3);
                if(i == 0){ //topleft
                    move  = randomn(2);
                    if(move == 1)
                        right_move();
                    else
                        bottom_move();
                } else if(i == size-1){ //bottomleft
                    move = randomn(2);
                    if(move == 1)
                        right_move();
                    else
                        top_move();
                } else {
                    if(move == 1)
                        top_move();   
                    else if (move == 2)
                        bottom_move();
                     else if (move == 3)
                        right_move();
                }
            } else {
                tokens[i][j-1].push(tokens[i][j].splice(x,1)*1);
            }
        }

    }

    var chitchat = function(grid, numturns) {
        var turns = 0;
        var data = [];
        var tokens = grid.slice(0);
        while(turns != numturns){
            for(var i=0; i<size; i++){
                for(var j=0; j<size; j++){
                    thisbox = tokens[i][j];
                    for(var x=0; x< thisbox.length; x++){
                        var actual_var = i*size + j;
                        if(tokens[i][j][x] == actual_var){
                            //do nothing
                        } else {
                            make_move(tokens,i,j,x);
                        }                    
                    }

                }
            }
            //find how many are done
            var numDone = 0;
            for(var i=0; i<size; i++){
                for(var j=0; j<size; j++){
                    for(var x=0; x<tokens[i][j].length; x++){
                        var actual_var = i*size + j;
                        if(tokens[i][j][x] == actual_var){
                            numDone++;
                        }
                    }
                }
            }
            if(numDone == 100){
                //console.log(turns);
                break;
            }
            //console.log(numDone);
    //        console.log(tokens);
            messages = document.getElementById("messages");
            //messages.innerHTML += numDone + "<br />";
            data.push(numDone);
            turns++;
        }
        //console.log(data);
        
        drawBoard(tokens); 
        plotGraph(data);
    };
    var drawBoard = function(grid) {
        var table = document.createElement("table");
        var main = document.getElementById("main");
        //console.log(main);
        table.style.border="1px solid #333"; 
        for(var i=0; i< size; i++) {
            var tr = document.createElement("tr");
            table.appendChild(tr)
            for(var j=0; j< size; j++) {

                var td = document.createElement("td");
                var x=0;
                //var sp = document.createElement("div");
                if(grid[i][j].length >= size/5){
                    td.className="danger";
                }
                for(var x=0; x<grid[i][j].length; x++){
                    
                    var actual_var = i*size + j;
                    if(grid[i][j][x] == actual_var){
                        td.className="safe";
                    }                   
                    
                    td.innerHTML += grid[i][j][x] ;
                    if(x != grid[i][j].length - 1){
                        td.innerHTML += ",";
                    }

                }
                tr.appendChild(td);
            }
        }
        //document.appendChild(table);
        //console.log(table);
        main.appendChild(table);
    }
    var init = function(){
        size = 10;
        room = size*size;
        grid = [];
        var seq = [];
        for(var i=0; i<size*size; i++){
            seq[i] = i;
        }

        shuffle(seq);
        for(var i=0; i<size; i++){
            grid[i] = []
            for(var j=0; j<size; j++){
                grid[i][j] = []            
                grid[i][j][0] =seq[i*size + j];
            }
        }
        drawBoard(grid);
        var button = document.getElementById("run");
        //run.onclick = function(e){
        chitchat(grid, TURNS);      
        //     console.log("yo");
        //}
//        console.log(grid);
         
    }

    init();
       
    </script>

</html>


